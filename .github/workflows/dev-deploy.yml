name: Dev - Tests + Deploy

on:
  push:
    branches:
      - dev

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Si les tests sont OK, on dÃ©ploie sur le VPS
      - name: Deploy to VPS and restart radio
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e

            echo "ðŸ“‚ Aller dans /var/www/html"
            cd /var/www/html

            # Branche du push (dev ou sandbox)
            BRANCH="${GITHUB_REF_NAME:-dev}"
            echo "ðŸ”€ Push reÃ§u sur la branche ${BRANCH}"

            # Branche actuellement checkout sur le serveur
            CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD)"
            echo "ðŸ“Œ Branche actuelle sur le serveur : ${CURRENT_BRANCH}"

            # 1) Si le serveur est sur main â†’ on ne touche Ã  rien
            if [ "$CURRENT_BRANCH" = "main" ]; then
              echo "ðŸ›‘ Le serveur est sur 'main'."
              echo "    Politique : pas de dÃ©ploiement auto depuis ${BRANCH} lorsque 'main' est checkout."
              exit 0
            fi

            # 2) Si la branche du serveur est diffÃ©rente de la branche poussÃ©e â†’ on ne change pas
            if [ "$CURRENT_BRANCH" != "$BRANCH" ]; then
              echo "ðŸ›‘ Branche serveur (${CURRENT_BRANCH}) diffÃ©rente de la branche poussÃ©e (${BRANCH})."
              echo "    Politique : pas de checkout automatique. Aucun dÃ©ploiement effectuÃ©."
              exit 0
            fi

            # 3) OK, on est sur la mÃªme branche que le push â†’ on dÃ©ploie
            echo "âœ… DÃ©ploiement de la branche ${BRANCH} sur le serveur."

            git fetch origin
            git reset --hard "origin/${BRANCH}"

            echo "ðŸŽµ Restart Icecast2 + Liquidsoap"
            # Si tu veux encore les dÃ©sactiver, commente ces lignes :
            systemctl restart icecast2
            systemctl restart liquidsoap

            echo "ðŸŽ‰ DÃ©ploiement terminÃ© pour ${BRANCH}"
